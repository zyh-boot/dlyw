<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <title>首页</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" th:href="@{../app/css/weui.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{../app/css/jquery-weui.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{../app/font/iconfont.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{../app/css/content.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{../app/css/main.css}"/>
    <style type="text/css">
        .weui-flex {
            background: #071449;
            color: #aaa;
        }

        .weui-cells__title {
            color: white;
            font-size: 20px;
            font-weight: bolder;
            margin-top: 2px;
        }
    </style>
</head>

<body ontouchstart>
<div class="swiper-container" id="box">
    <div class="swiper-wrapper">
        <div class="swiper-slide">
            <img th:src="@{images/zg1.jpg}"/>
        </div>
        <div class="swiper-slide">
            <img th:src="@{images/zg2.jpg}"/>
        </div>
        <div class="swiper-slide">
            <img th:src="@{images/zg3.jpg}"/>
        </div>
    </div>
</div>

<div class="weui-flex">
<!--    <div>-->
<!--        <div class="iconfont icon-laba notice"></div>-->
<!--    </div>-->
<!--    <div class="weui-flex__item">-->
<!--        <div class="swiper-container" id="swiperBox">-->
<!--            <div class="swiper-wrapper">-->
<!--                <div class="swiper-slide">-->
<!--                    1001炒货机正在工作 10时之前-->
<!--                </div>-->

<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
</div>

<div class="spList" id="spBox" style="height: calc(100% - 239px)">
    <div class="spBox">
        <div class="weui-cells__title" style="">设备历史列表</div>
        <div id="list">

            <div></div>

        </div>

    </div>
    <div class="weui-loadmore" style="padding-bottom:30px;height:20px;color: white" id="scroll">
        <i class="weui-loading"></i>
        <span class="weui-loadmore__tips">正在加载</span>
    </div>
</div>
<div class="weui-tabbar">
    <a href="index" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-shouye"></i>
        </div>
        <p class="weui-tabbar__label">炒货机</p>
    </a>
    <a id="sj" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-shijianguanli"></i>
        </div>
        <p class="weui-tabbar__label">事件</p>
    </a>
    <a id="jk" class="weui-tabbar__item weui-bar__item--on">
        <i class="weui-tabbar__label iconfont icon-gongzuotai" style="font-size: 27px;"></i>
    </a>
    <a id="history" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-lishi"></i>
        </div>
        <p class="weui-tabbar__label">历史</p>
    </a>
    <a href="mine" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-wode"></i>
        </div>
        <p class="weui-tabbar__label">我的</p>
    </a>
</div>
<!--<div class="weui-tabbar">
    <a href="index" class="weui-tabbar__item weui-bar__item&#45;&#45;on">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-shouye"></i>
        </div>
        <p class="weui-tabbar__label">炒货机</p>
    </a>
  &lt;!&ndash;  <a href="tobaccoIndex" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-shijianguanli"></i>
        </div>
        <p class="weui-tabbar__label">炕烟机</p>
    </a>&ndash;&gt;
    <a href="workbench.html" class="weui-tabbar__item">
        <i class="weui-tabbar__label iconfont icon-gongzuotai" style="font-size: 27px;"></i>
    </a>
    <a href="historyData.html" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-lishi"></i>
        </div>
        <p class="weui-tabbar__label">历史</p>
    </a>
    <a href="mine.html" class="weui-tabbar__item">
        <div class="weui-tabbar__icon">
            <i class="weui-tabbar__label iconfont icon-wode"></i>
        </div>
        <p class="weui-tabbar__label">我的</p>
    </a>
</div>-->

</body>
<script th:src="@{../app/js/jquery-3.4.1.min.js}" type="text/javascript" charset="utf-8"></script>
<script th:src="@{../app/js/jquery-weui.min.js}" type="text/javascript" charset="utf-8"></script>
<script th:src="@{../app/js/fastclick.js}" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    //去掉ios点击事件300毫秒延迟
    $(function () {
        FastClick.attach(document.body);
    });
</script>

<script th:src="@{../app/js/swiper.min.js}" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    $("#box").swiper({
        loop: true,
        autoplay: 3000
    });
    $("#swiperBox").swiper({
        loop: true,
        autoplay: 3000,
        direction: 'vertical'
    });


</script>
<!--搜索点击效果-->
<script>
    var kh_id = localStorage.getItem("khId"),
        records = [],
        havaData = false,
        start = 0,
        end = 8,
        type = 1,
        count = -1,
        jsonData = {
            "start": start,
            "end": end,
            "kh_id": kh_id,
            "type": type
        };

    //进入监控平台
    $("#jk").on("click", function () {
        let url = "workbench?khId=" + kh_id;
        window.location.href = url;
    })

    //进入事件模块
    $("#sj").on("click", function () {
        let url = "event?khId=" + kh_id;
        window.location.href = url;
    })

    //进入历史模块
    $("#history").on("click",function(){
        let url="history?khId="+kh_id;
        window.location.href=url;
    })
    function getData(jsonData) {
        $.get("history_sb", jsonData, function (res) {

            if (res.code == 200) {
                records = res.data.list;
                count = res.data.count; // 数据总条数
                if (records.length == 0 && !havaData) {
                    $("#scroll").hide();
                    var div = document.getElementById("list");
                    var str = '<h3 align="center" style="color: white" >暂无数据</h3>';
                    div.innerHTML = div.innerHTML + str;
                } else {
                    if (count <= 8) {
                        $("#scroll").hide();
                    } else {
                        havaData = true;
                    }
                }
                // 显示数据
                showData(records);
            } else {
                $.toast("加载数据失败!", "text");
                $("#spBox").destroyInfinite();
                $("#scroll").hide();
            }
        }, "json");
    }

    // 页面一进来就获取数据
    getData(jsonData);

    function showData(records) {

        var length = records.length;
        console.log(length)
        var str = "";


        for (var i = 0; i < length; i++) {
            str = "";
            var obj = records[i];

            //是否结束
            let isPeriod = obj.isPeriod;
            let exitStr = '';
            if (isPeriod == null || isPeriod == 0) {
                exitStr = '<span  style="color:yellow">结束</span>';
            } else {
                exitStr = '<span  style="color:greenyellow">未结束</span>';
            }

            const btnStrDouble = '<span><a onclick="gotoComment(' + obj.sbCode+','+ i +')"  class="weui-btn weui-btn_primary weui-form-preview__label" style="width: 30%; font-size: 16px" >评价</a></span>'
                + '<span style="float: right;"><a onclick="gotoDetail('+obj.sbCode+','+i+')"  class="weui-btn weui-btn_primary weui-form-preview__label" style="  font-size: 16px">查看详情</a></span>'
            // console.log("no-->" , test)
            // console.log(btnStrDouble)
            const btnStrOne = '<span><a onclick="gotoDetail('+obj.sbCode+','+i+')" class="weui-btn weui-btn_primary " style="font-size: 16px; color:#888;">查看详情</a></span>'
            // console.log(btnStrOne)

            var div = document.getElementById("list");
            str =   '<div class="weui-form-preview" id="' + obj.sbCode + '"  style="background-color: #071449;color: white;">'

                + '<div class="weui-form-preview__bd"><div class="weui-form-preview__item">'
                + ' <label class="weui-form-preview__label">设备名称:</label>'
                + '<span class="weui-form-preview__value">' + obj.sbCode + '</span></div></div>'

                + '<div class="weui-form-preview__bd"><div class="weui-form-preview__item">'
                + ' <label class="weui-form-preview__label">炒制周期:</label>'
                // 使用异常炒制周期
                // + '<span class="weui-form-preview__value">' + (entity.periodId == null ? "周期无数据" : entity.periodId) + '</span></div></div>'
                + '<span class="weui-form-preview__value" id="z'+i+'">'
                + (obj.periodNo == null ? "周期无数据" : obj.periodNo) + '</span></div></div>'


                + '<div class="weui-form-preview__bd"><div class="weui-form-preview__item">'
                + '<label class="weui-form-preview__label">炒制时长:</label>'
                + '<span class="weui-form-preview__value">' + (obj.workSc == null ? "缺失数据" : obj.workSc)+ '</span></div></div>'

                + '<div class="weui-form-preview__bd"><div class="weui-form-preview__item">'
                + ' <label class="weui-form-preview__label">是否结束:</label>'
                + '<em class="weui-form-preview__value">' + exitStr + '</em></div></div>'

                + '<div class="weui-form-preview__bd"><div class="weui-form-preview__item">'
                + (isPeriod == 1 ? btnStrOne : btnStrDouble)
                + '</div></div>'
            div.innerHTML = div.innerHTML + str;
            // console.log(div.innerHTML)

        }



        if (length == 0) {
            $("#scroll").hide();
        }
    }

    function gotoComment(sbcode,index) {
        let period = $("#z" + index).text()
        let url = "comment?&khId=" + kh_id + "&sbCode=" + sbcode + "&period=" + period;
        localStorage.setItem("khId",kh_id);
        localStorage.setItem("sb_code",sbcode);
        localStorage.setItem("period",period);
        window.location.href = url;
    }

    function gotoDetail(sbcode,index){
        let url = "detail?period=" + index + "&code=" + sbcode
        window.location.href = url;
    }
    // 滚动条滑动到离底部100，多显示一条数据。 显示后不会消失。
    //$("#spBox").infinite(150);
    var loading = false;  //状态标记 否则一直循环刷新
    $("#spBox").infinite(150).on("infinite", function () {
        if (loading) return;
        loading = true;
        setTimeout(function () {
            var length = records.length;
            if (length > 0 && havaData) {
                // 还有数据，继续加载
                start = start + 8;
                end = start + 8;
                var jsonData = {
                    "start": start,
                    "end": end,
                    "kh_id": kh_id
                };
                getData(jsonData);
            } else {
                havaData = false;
                $.toast("全部数据已经加载完成！", "text");
                $("#spBox").destroyInfinite();
                $("#scroll").hide();
                return;
            }
            loading = false;
        }, 50);   //模拟延迟
    });



</script>

</html>
